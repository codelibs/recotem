version: "3.7"
services:
  queue:
    image: rabbitmq:3
    ports:
      - "5672:5672"
  backend:
    depends_on:
      - queue
    build:
      context: ./backend
      dockerfile: backend.dockerfile
      args:
        - RECOTEM_TESTING=true
    volumes:
      - ./backend/recotem:/app
    ports:
      - "8000:80"
    environment:
      - DJANGO_SETTINGS_MODULE=recotem.settings
      - CELERY_BROKER_URL=amqp://guest@queue:5672
      - RECOTEM_TESTING=true
    command: >
      sh -c '
        if ! pytest -s --cov=./recotem/ --cov-report=html ; then
          echo "test failed"
          exit 1;
        fi
        coverage xml
        rm -rf data/training_data
        rm -rf data/models
      '
