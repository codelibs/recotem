name: Full Test & Upload coverage
on:
  push:
    branches:
      - '**'
  pull_request:
  workflow_dispatch:

jobs:
  run_frontend_tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install dependencies
        working-directory: frontend
        run: npm ci
      - name: Type check
        working-directory: frontend
        run: npm run type-check
      - name: Lint
        working-directory: frontend
        run: npm run lint
      - name: Unit tests with coverage
        working-directory: frontend
        run: npx vitest run --coverage
      - name: Save frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/lcov.info

  run_playwright:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci
      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps
      - name: Build and start services
        env:
          SECRET_KEY: ci-test-secret-key-not-for-production
        run: |
          docker compose build
          docker compose up -d
          until curl -f http://localhost:8000/api/ping/
          do
            echo "Waiting for services..."
            sleep 2
          done
      - name: Run Playwright tests
        working-directory: frontend
        run: npx playwright test
      - name: Save test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          path: frontend/playwright-report/
          name: playwright-report

  run_pytest:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: recotem_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: recotem
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://recotem_user:test_password@localhost:5432/recotem
      CELERY_BROKER_URL: redis://localhost:6379/0
      DJANGO_SETTINGS_MODULE: recotem.settings
      SECRET_KEY: ci-test-secret-key-not-for-production
      RECOTEM_TESTING: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django
      - name: Cache MovieLens dataset
        uses: actions/cache@v4
        with:
          path: ~/.cache/irspack
          key: movielens-100k
      - name: Download test data
        run: python -c "from irspack.dataset import MovieLens100KDataManager; MovieLens100KDataManager(force_download=True)"
      - name: Run pytest
        working-directory: backend/recotem
        run: pytest -s --cov=./recotem/ --cov-report=xml tests/
      - name: Validate OpenAPI schema is up to date
        working-directory: backend/recotem
        run: |
          python manage.py spectacular --file /tmp/schema.yml
          if [ -f ../../docs/openapi-schema.yml ]; then
            diff ../../docs/openapi-schema.yml /tmp/schema.yml || \
              (echo "OpenAPI schema is out of date. Run: cd backend/recotem && python manage.py spectacular --file ../../docs/openapi-schema.yml" && exit 1)
          fi
      - name: Save coverage
        uses: actions/upload-artifact@v4
        with:
          name: pytest-coverage
          path: backend/recotem/coverage.xml

  upload-coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [run_pytest, run_frontend_tests]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: pytest-coverage
          path: coverage-backend
      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: coverage-frontend
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          verbose: false
          name: codecov-umbrella
          fail_ci_if_error: false
